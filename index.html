<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lisa - AI Video Processing Tool</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: #f5f5f5;
        min-height: 100vh;
        color: #333;
      }

      .header {
        background: white;
        padding: 20px 40px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo img {
        height: 40px;
        width: auto;
      }

      .logo-text {
        font-size: 24px;
        font-weight: 600;
        color: #1a1a1a;
      }

      .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .upload-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .card-header {
        padding: 32px 40px 24px;
        border-bottom: 1px solid #f0f0f0;
      }

      .card-title {
        font-size: 28px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
      }

      .card-subtitle {
        color: #666;
        font-size: 16px;
        line-height: 1.5;
      }

      .upload-area {
        padding: 40px;
        text-align: center;
      }

      .drag-drop-zone {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 60px 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
        position: relative;
      }

      .drag-drop-zone:hover {
        border-color: #3b82f6;
        background: #f8fafc;
      }

      .drag-drop-zone.dragover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: scale(1.02);
      }

      .upload-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 24px;
        background: #3b82f6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
      }

      .upload-text {
        font-size: 18px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
      }

      .upload-hint {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 24px;
      }

      .browse-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .browse-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }

      .file-input {
        display: none;
      }

      .progress-section {
        padding: 0 40px 40px;
        display: none;
      }

      .progress-container {
        background: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .progress-text {
        font-weight: 500;
        color: #374151;
      }

      .progress-percentage {
        font-size: 14px;
        color: #6b7280;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      .status {
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .status.info {
        background: #eff6ff;
        color: #1e40af;
        border: 1px solid #dbeafe;
      }

      .status.success {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .status.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .status.warning {
        background: #fffbeb;
        color: #d97706;
        border: 1px solid #fed7aa;
      }

      .btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 8px 8px 8px 0;
      }

      .btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .results-section {
        margin-top: 40px;
        display: none;
      }

      .results-header {
        margin-bottom: 24px;
      }

      .results-title {
        font-size: 24px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
      }

      .results-subtitle {
        color: #666;
        margin-bottom: 2rem;
        text-align: center;
      }

      .download-all-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 auto;
        display: block;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .download-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .download-all-btn:active {
        transform: translateY(0);
      }

      .download-all-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .clear-results-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 10px;
      }

      .clear-results-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .clear-results-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .result-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }

      .result-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .result-card h3 {
        color: #1a1a1a;
        margin-bottom: 16px;
        font-size: 18px;
        font-weight: 600;
      }

      .result-item {
        margin: 12px 0;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 3px solid #3b82f6;
      }

      .result-item h4 {
        color: #374151;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .result-item p {
        color: #6b7280;
        font-size: 13px;
        line-height: 1.4;
      }

      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .video-card {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
      }

      .video-card h4 {
        color: #374151;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .video-player {
        width: 100%;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .video-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #6b7280;
      }

      .uploaded-files {
        margin-top: 24px;
        padding: 0 40px 40px;
      }

      .files-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 16px;
      }

      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #e5e7eb;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .file-icon {
        width: 32px;
        height: 32px;
        background: #3b82f6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
      }

      .file-details {
        display: flex;
        flex-direction: column;
      }

      .file-name {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
      }

      .file-size {
        color: #6b7280;
        font-size: 12px;
      }

      .file-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-success {
        color: #059669;
      }

      .status-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
      }

      .status-icon.success {
        background: #10b981;
        color: white;
      }

      /* File Info Styles */
      .file-info {
        background: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #e5e7eb;
      }

      .file-info h3 {
        color: #1a1a1a;
        margin-bottom: 16px;
        font-size: 18px;
        font-weight: 600;
      }

      .file-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .file-detail {
        font-size: 14px;
        color: #6b7280;
      }

      .file-detail strong {
        color: #374151;
        font-weight: 500;
      }

      /* S3 URL Input Styles */
      .upload-section {
        margin: 24px 0;
        padding: 0 40px;
      }

      .upload-section h3 {
        color: #1a1a1a;
        margin-bottom: 16px;
        font-size: 18px;
        font-weight: 600;
      }

      .s3-input-container {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .s3-url-input {
        flex: 1;
        min-width: 300px;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }

      .s3-url-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .s3-info {
        background: #eff6ff;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #dbeafe;
      }

      .s3-info h4 {
        color: #1e40af;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
      }

      .s3-info p {
        color: #1e40af;
        font-family: monospace;
        word-break: break-all;
        margin: 0;
        font-size: 13px;
      }

      /* Video Type Selection Styles */
      .video-type-section {
        padding: 0 40px 24px;
        border-bottom: 1px solid #f0f0f0;
      }

      .video-type-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 16px;
      }

      .video-type-options {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .video-type-option {
        flex: 1;
        min-width: 200px;
        cursor: pointer;
        position: relative;
      }

      .video-type-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
      }

      .radio-custom {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background-color: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.2s ease;
      }

      .video-type-option:hover .radio-custom {
        border-color: #3b82f6;
        background-color: #f8fafc;
      }

      .video-type-option input[type="radio"]:checked ~ .radio-custom {
        border-color: #3b82f6;
        background-color: #eff6ff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .option-content {
        position: relative;
        z-index: 1;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .option-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #3b82f6;
        border-radius: 8px;
        color: white;
      }

      .option-text {
        flex: 1;
      }

      .option-title {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .option-description {
        color: #6b7280;
        font-size: 12px;
        line-height: 1.4;
      }

      /* Video Preview Styles */
      .video-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .video-preview-item {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        transition: transform 0.2s ease;
      }

      .video-preview-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .video-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .video-preview-header h4 {
        margin: 0;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
      }

      .video-size {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
      }

      .video-preview {
        width: 100%;
        border-radius: 6px;
        background: #000;
      }

      /* Loading Animation */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .container {
          margin: 20px auto;
          padding: 0 16px;
        }

        .header {
          padding: 16px 20px;
        }

        .logo-text {
          font-size: 20px;
        }

        .card-header {
          padding: 24px 24px 20px;
        }

        .card-title {
          font-size: 24px;
        }

        .upload-area {
          padding: 24px;
        }

        .drag-drop-zone {
          padding: 40px 24px;
        }

        .results-grid {
          grid-template-columns: 1fr;
        }

        .video-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">
        <img
          src="https://cdn.prod.website-files.com/646b1aaa6e6c6171bccb6fcf/646b71e7130d9c4bb577cba6_Lisa%20-%20Final%20-%20Logo%20-%20black.svg"
          alt="Lisa Logo"
        />
        <span class="logo-text"></span>
      </div>
    </div>

    <div class="container">
      <div class="upload-card">
        <div class="card-header">
          <h1 class="card-title">AI Video Processing Tool</h1>
          <p class="card-subtitle">
            Upload your video and let our AI automatically segment it into
            meaningful topics
          </p>
        </div>

        <!-- Video Type Selection -->
        <div class="video-type-section">
          <h3 class="video-type-title">Video Type</h3>
          <div class="video-type-options">
            <label class="video-type-option">
              <input type="radio" name="videoType" value="live" checked />
              <span class="radio-custom"></span>
              <div class="option-content">
                <div class="option-icon">üé•</div>
                <div class="option-text">
                  <div class="option-title">Live Session</div>
                  <div class="option-description">
                    With student interactions and Q&A
                  </div>
                </div>
              </div>
            </label>
            <label class="video-type-option">
              <input type="radio" name="videoType" value="recorded" />
              <span class="radio-custom"></span>
              <div class="option-content">
                <div class="option-icon">üìπ</div>
                <div class="option-text">
                  <div class="option-title">Recorded Video</div>
                  <div class="option-description">
                    Topic-based segmentation only
                  </div>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="upload-area">
          <div class="drag-drop-zone" id="dragDropZone">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Drag and Drop</div>
            <div class="upload-hint">or</div>
            <button
              class="browse-btn"
              onclick="document.getElementById('fileInput').click()"
            >
              Browse file
            </button>
            <input
              type="file"
              id="fileInput"
              class="file-input"
              accept="video/*"
            />
          </div>
        </div>

        <div class="progress-section" id="progressSection">
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-text">Uploading video...</span>
              <span class="progress-percentage" id="progressPercentage"
                >0%</span
              >
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
        </div>

        <div class="uploaded-files" id="uploadedFiles" style="display: none">
          <h3 class="files-title">Uploaded Files</h3>
          <div id="filesList"></div>
        </div>

        <!-- File Info Section -->
        <div class="file-info" id="fileInfo" style="display: none">
          <h3>üìã File Information</h3>
          <div class="file-details">
            <div class="file-detail">
              <strong>Name:</strong> <span id="fileName"></span>
            </div>
            <div class="file-detail">
              <strong>Size:</strong> <span id="fileSize"></span>
            </div>
            <div class="file-detail">
              <strong>Type:</strong> <span id="fileType"></span>
            </div>
            <div class="file-detail">
              <strong>Duration:</strong> <span id="fileDuration"></span>
            </div>
          </div>
        </div>

        <!-- S3 URL Input Section -->
        <div class="upload-section">
          <h3>üåê Or Enter S3 URL</h3>
          <div class="s3-input-container">
            <input
              type="url"
              id="s3UrlInput"
              placeholder="https://your-bucket.s3.region.amazonaws.com/video.mp4"
              class="s3-url-input"
            />
            <button class="btn" id="processS3Btn" style="display: none">
              üöÄ Process S3 Video
            </button>
          </div>
          <div class="s3-info" id="s3Info" style="display: none">
            <h4>üìã S3 URL:</h4>
            <p id="s3UrlDisplay"></p>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="statusContainer"></div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin: 30px 0">
          <button class="btn" id="uploadBtn" style="display: none">
            üöÄ Upload to S3
          </button>
          <button class="btn" id="processBtn" style="display: none">
            ‚öôÔ∏è Process Video
          </button>
        </div>
      </div>

      <div class="results-section" id="resultsSection">
        <div class="results-header">
          <h2 class="results-title">Processing Results</h2>
          <p class="results-subtitle">
            Your video has been processed and segmented into topics
          </p>
          <button
            id="downloadAllBtn"
            class="download-all-btn"
            style="display: none"
          >
            üì¶ Download All Segments
          </button>
          <button
            id="clearResultsBtn"
            class="clear-results-btn"
            style="display: none"
          >
            üóëÔ∏è Clear Results
          </button>
        </div>

        <div class="results-grid" id="resultsGrid"></div>
      </div>
    </div>

    <script>
      // API Configuration - Updated for Modal Queue deployment
      const API_BASE_URL =
        "https://lu-labs--script-trimmer-get-presigned-url-endpoint.modal.run";
      const PROCESSING_API_URL =
        "https://lu-labs--script-trimmer-extract-audio-endpoint.modal.run";
      const PROGRESS_STREAM_URL =
        "https://lu-labs--script-trimmer-progress-stream-endpoint.modal.run";

      // Global variables
      let selectedFile = null;
      let presignedUrl = null;
      let s3Url = null;
      let currentResults = null; // Store current results for persistence

      // Local storage keys
      const STORAGE_KEYS = {
        RESULTS: "script_trimmer_results",
        S3_URL: "script_trimmer_s3_url",
        TIMESTAMP: "script_trimmer_timestamp",
      };

      // DOM elements
      const uploadArea = document.getElementById("dragDropZone");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const progressSection = document.getElementById("progressSection");
      const statusContainer = document.getElementById("statusContainer");
      const uploadBtn = document.getElementById("uploadBtn");
      const processBtn = document.getElementById("processBtn");
      const resultsSection = document.getElementById("resultsSection");
      const downloadAllBtn = document.getElementById("downloadAllBtn");
      const clearResultsBtn = document.getElementById("clearResultsBtn");

      // S3 URL elements
      const s3UrlInput = document.getElementById("s3UrlInput");
      const processS3Btn = document.getElementById("processS3Btn");
      const s3Info = document.getElementById("s3Info");
      const s3UrlDisplay = document.getElementById("s3UrlDisplay");

      // Event listeners
      uploadArea.addEventListener("click", () => fileInput.click());
      uploadArea.addEventListener("dragover", handleDragOver);
      uploadArea.addEventListener("dragleave", handleDragLeave);
      uploadArea.addEventListener("drop", handleDrop);
      fileInput.addEventListener("change", handleFileSelect);
      uploadBtn.addEventListener("click", handleUpload);
      processBtn.addEventListener("click", handleProcess);
      downloadAllBtn.addEventListener("click", downloadAllSegments);
      clearResultsBtn.addEventListener("click", clearResults);

      // S3 URL event listeners
      s3UrlInput.addEventListener("input", handleS3UrlInput);
      processS3Btn.addEventListener("click", handleS3Process);

      // Local storage functions
      function saveToLocalStorage(data, s3Url) {
        try {
          const storageData = {
            results: data,
            s3_url: s3Url,
            timestamp: new Date().toISOString(),
          };
          localStorage.setItem(
            STORAGE_KEYS.RESULTS,
            JSON.stringify(storageData)
          );
          console.log("üíæ Data saved to local storage");
        } catch (error) {
          console.error("‚ùå Error saving to local storage:", error);
        }
      }

      function loadFromLocalStorage() {
        try {
          const stored = localStorage.getItem(STORAGE_KEYS.RESULTS);
          if (stored) {
            const data = JSON.parse(stored);
            const timestamp = new Date(data.timestamp);
            const now = new Date();
            const hoursDiff = (now - timestamp) / (1000 * 60 * 60);

            // Only restore if data is less than 24 hours old
            if (hoursDiff < 24) {
              console.log("üìÇ Restoring data from local storage");
              currentResults = data.results;
              s3Url = data.s3_url;

              // Update S3 URL input if it exists
              if (s3UrlInput && s3Url) {
                s3UrlInput.value = s3Url;
              }

              // Display restored results
              if (currentResults) {
                displayResults(currentResults);
                showStatus(
                  "üìÇ Restored previous results from local storage",
                  "info"
                );
              }
              return true;
            } else {
              // Clear old data
              clearLocalStorage();
              console.log("üóëÔ∏è Cleared old local storage data (>24 hours)");
            }
          }
        } catch (error) {
          console.error("‚ùå Error loading from local storage:", error);
          clearLocalStorage();
        }
        return false;
      }

      function clearLocalStorage() {
        try {
          localStorage.removeItem(STORAGE_KEYS.RESULTS);
          localStorage.removeItem(STORAGE_KEYS.S3_URL);
          localStorage.removeItem(STORAGE_KEYS.TIMESTAMP);
          console.log("üóëÔ∏è Local storage cleared");
        } catch (error) {
          console.error("‚ùå Error clearing local storage:", error);
        }
      }

      // Load data on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadFromLocalStorage();
      });

      // Drag and drop handlers
      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      }

      // File selection handler
      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      // File handling
      function handleFile(file) {
        // Validate file type
        const allowedTypes = [
          "video/mp4",
          "video/avi",
          "video/mov",
          "video/mkv",
          "video/flv",
          "video/wmv",
          "video/webm",
          "video/m4v",
          "video/3gp",
        ];
        if (!allowedTypes.includes(file.type)) {
          showStatus("Please select a valid video file.", "error");
          return;
        }

        // Validate file size (10GB max)
        const maxSize = 10 * 1024 * 1024 * 1024; // 10GB in bytes
        if (file.size > maxSize) {
          showStatus(
            "File size exceeds 10GB limit. Please select a smaller file.",
            "error"
          );
          return;
        }

        selectedFile = file;
        displayFileInfo(file);
        showStatus(
          'File selected successfully! Click "Process Video" to continue.',
          "success"
        );
        uploadBtn.style.display = "inline-block";
        processBtn.style.display = "inline-block"; // Show process button immediately
      }

      // Display file information
      function displayFileInfo(file) {
        const fileName = document.getElementById("fileName");
        const fileSize = document.getElementById("fileSize");
        const fileType = document.getElementById("fileType");
        const fileDuration = document.getElementById("fileDuration");

        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileType.textContent = file.type;

        // Create video element to get duration
        const video = document.createElement("video");
        video.preload = "metadata";
        video.onloadedmetadata = function () {
          const duration = Math.round(video.duration);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          fileDuration.textContent = `${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;
        };
        video.src = URL.createObjectURL(file);

        fileInfo.style.display = "block";
      }

      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Upload to S3
      async function handleUpload() {
        if (!selectedFile) {
          showStatus("Please select a file first.", "error");
          return;
        }

        uploadBtn.disabled = true;
        uploadBtn.innerHTML =
          '<span class="loading"></span>Getting presigned URL...';
        progressSection.style.display = "block";
        updateProgress(0, "Getting presigned URL...");

        try {
          // Step 1: Get presigned URL
          const presignedResponse = await getPresignedUrl(
            selectedFile.name,
            selectedFile.type
          );
          if (!presignedResponse.success) {
            throw new Error(presignedResponse.error);
          }

          presignedUrl = presignedResponse.presigned_url;
          s3Url = presignedResponse.s3_url;

          updateProgress(20, "Presigned URL received. Uploading to S3...");
          uploadBtn.innerHTML =
            '<span class="loading"></span>Uploading to S3...';

          // Step 2: Upload to S3
          const uploadSuccess = await uploadToS3WithProgress(
            presignedUrl,
            selectedFile
          );
          if (!uploadSuccess) {
            throw new Error("Failed to upload file to S3");
          }

          updateProgress(100, "Upload completed successfully!");
          showStatus(
            'Video uploaded to S3 successfully! Click "Process Video" to continue.',
            "success"
          );

          uploadBtn.style.display = "none";
          processBtn.style.display = "inline-block";
          processBtn.disabled = false;
        } catch (error) {
          console.error("Upload error:", error);
          showStatus(`Upload failed: ${error.message}`, "error");
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = "üöÄ Upload to S3";
        }
      }

      // Get presigned URL
      async function getPresignedUrl(filename, contentType) {
        try {
          console.log("Getting presigned URL for:", filename, contentType);
          showStatus("üîç Getting presigned URL...", "info");

          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              filename: filename,
              content_type: contentType,
            }),
          });

          console.log("Response status:", response.status);
          const data = await response.json();
          console.log("Response data:", data);

          if (response.ok) {
            showStatus("‚úÖ Presigned URL received successfully!", "success");
            return { success: true, ...data };
          } else {
            showStatus(
              `‚ùå Failed to get presigned URL: ${data.detail}`,
              "error"
            );
            return {
              success: false,
              error: data.detail || "Failed to get presigned URL",
            };
          }
        } catch (error) {
          console.error("Fetch error:", error);
          showStatus(`‚ùå Network error: ${error.message}`, "error");
          return { success: false, error: error.message };
        }
      }

      // Upload to S3 with progress
      async function uploadToS3WithProgress(presignedUrl, file) {
        return new Promise((resolve) => {
          console.log("Uploading to S3 with presigned URL:", presignedUrl);
          console.log("File type:", file.type);
          console.log("File size:", file.size);
          showStatus("‚òÅÔ∏è Starting S3 upload...", "info");

          const xhr = new XMLHttpRequest();

          xhr.upload.addEventListener("progress", (e) => {
            if (e.lengthComputable) {
              const percentComplete = (e.loaded / e.total) * 100;
              const progress = 20 + percentComplete * 0.8; // 20% to 100%
              updateProgress(
                progress,
                `Uploading: ${Math.round(percentComplete)}%`
              );
            }
          });

          xhr.addEventListener("load", () => {
            console.log("XHR load event - status:", xhr.status);
            console.log("XHR response:", xhr.responseText);
            if (xhr.status === 200) {
              showStatus("‚úÖ S3 upload completed successfully!", "success");
              resolve(true);
            } else {
              console.error("Upload failed with status:", xhr.status);
              showStatus(
                `‚ùå S3 upload failed with status: ${xhr.status}`,
                "error"
              );
              resolve(false);
            }
          });

          xhr.addEventListener("error", (e) => {
            console.error("XHR error:", e);
            showStatus("‚ùå S3 upload network error", "error");
            resolve(false);
          });

          xhr.open("PUT", presignedUrl);
          xhr.setRequestHeader("Content-Type", file.type);
          xhr.send(file);
        });
      }

      // S3 URL input handler
      function handleS3UrlInput(e) {
        const url = e.target.value.trim();
        console.log("üîç S3 URL input:", url);
        
        if (url) {
          const isValid = isValidS3Url(url);
          console.log("‚úÖ S3 URL validation result:", isValid);
          
          if (isValid) {
            processS3Btn.style.display = "inline-block";
            s3UrlDisplay.textContent = url;
            s3Info.style.display = "block";
            showStatus("‚úÖ Valid S3 URL detected! Click 'Process S3 Video' to continue.", "success");
          } else {
            // Show button anyway with a warning for testing
            processS3Btn.style.display = "inline-block";
            s3UrlDisplay.textContent = url;
            s3Info.style.display = "block";
            showStatus("‚ö†Ô∏è URL format not recognized as S3, but you can try processing anyway.", "warning");
          }
        } else {
          processS3Btn.style.display = "none";
          s3Info.style.display = "none";
        }
      }

      // Validate S3 URL format - More flexible validation
      function isValidS3Url(url) {
        try {
          const urlObj = new URL(url);
          console.log("üîç URL hostname:", urlObj.hostname);

          // More flexible validation - check for common S3 patterns
          const hostname = urlObj.hostname.toLowerCase();

          // Check for various S3 URL patterns
          const s3Patterns = [
            /\.s3\./,
            /\.s3-.*\.amazonaws\.com/,
            /s3\.amazonaws\.com/,
            /s3-.*\.amazonaws\.com/,
            /.*\.s3\.amazonaws\.com/,
            /.*\.s3-.*\.amazonaws\.com/,
          ];

          const isValid = s3Patterns.some((pattern) => pattern.test(hostname));
          console.log("üîç S3 pattern match result:", isValid);

          return isValid;
        } catch (error) {
          console.error("‚ùå URL parsing error:", error);
          return false;
        }
      }

      // Process S3 URL directly
      async function handleS3Process() {
        const s3Url = s3UrlInput.value.trim();

        if (!s3Url) {
          showStatus("Please enter a valid S3 URL.", "error");
          return;
        }

        if (!isValidS3Url(s3Url)) {
          showStatus("Please enter a valid S3 URL format.", "error");
          return;
        }

        processS3Btn.disabled = true;
        processS3Btn.innerHTML =
          '<span class="loading"></span>Processing S3 video...';

        // Show progress section
        progressSection.style.display = "block";
        updateProgress(
          0,
          "Starting S3 video processing with real-time updates..."
        );

        try {
          console.log(
            "üöÄ Sending S3 processing request to:",
            PROCESSING_API_URL
          );
          // Get selected video type
          const videoType = document.querySelector(
            'input[name="videoType"]:checked'
          ).value;
          console.log("üì§ Request payload:", {
            s3_url: s3Url,
            video_type: videoType,
          });

          // Start the processing job
          const response = await fetch(PROCESSING_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              s3_url: s3Url,
              video_type: videoType,
            }),
          });

          console.log("üì• Processing response status:", response.status);
          const data = await response.json();
          console.log("üìä Processing response data:", data);

          if (response.ok) {
            showStatus("‚úÖ S3 processing job started successfully!", "success");

            // Start real-time progress streaming
            startProgressStream(s3Url);
          } else {
            console.error("‚ùå Processing failed with status:", response.status);
            console.error("‚ùå Error details:", data);
            throw new Error(data.detail || data.message || "Processing failed");
          }
        } catch (error) {
          console.error("‚ùå Processing error:", error);
          showStatus(`Processing failed: ${error.message}`, "error");
          processS3Btn.disabled = false;
          processS3Btn.innerHTML = "üöÄ Process S3 Video";
        }
      }

      // Process video with real-time progress updates
      async function handleProcess() {
        if (!selectedFile && !s3Url) {
          showStatus(
            "No file selected or S3 URL available. Please select a file first.",
            "error"
          );
          return;
        }

        processBtn.disabled = true;
        processBtn.innerHTML =
          '<span class="loading"></span>Processing video...';
        progressSection.style.display = "block";
        updateProgress(0, "Starting video processing...");

        try {
          let finalS3Url = s3Url;

          // If we have a selected file but no S3 URL, upload it first
          if (selectedFile && !s3Url) {
            updateProgress(10, "Getting presigned URL...");

            // Step 1: Get presigned URL
            const presignedResponse = await getPresignedUrl(
              selectedFile.name,
              selectedFile.type
            );
            if (!presignedResponse.success) {
              throw new Error(presignedResponse.error);
            }

            updateProgress(20, "Uploading to S3...");

            // Step 2: Upload to S3
            const uploadSuccess = await uploadToS3WithProgress(
              presignedResponse.presigned_url,
              selectedFile
            );
            if (!uploadSuccess) {
              throw new Error("S3 upload failed");
            }

            // Set the S3 URL for processing
            finalS3Url = presignedResponse.s3_url;
            s3Url = finalS3Url;
          }

          updateProgress(30, "Starting video processing...");

          console.log("üöÄ Sending processing request to:", PROCESSING_API_URL);
          // Get selected video type
          const videoType = document.querySelector(
            'input[name="videoType"]:checked'
          ).value;
          console.log("üì§ Request payload:", {
            s3_url: finalS3Url,
            video_type: videoType,
          });

          // Start the processing job
          const response = await fetch(PROCESSING_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              s3_url: finalS3Url,
              video_type: videoType,
            }),
          });

          console.log("üì• Processing response status:", response.status);
          const data = await response.json();
          console.log("üìä Processing response data:", data);

          if (response.ok) {
            showStatus("‚úÖ Processing job started successfully!", "success");

            // Start real-time progress streaming
            startProgressStream(finalS3Url);
          } else {
            console.error("‚ùå Processing failed with status:", response.status);
            console.error("‚ùå Error details:", data);
            throw new Error(data.detail || data.message || "Processing failed");
          }
        } catch (error) {
          console.error("‚ùå Processing error:", error);
          showStatus(`Processing failed: ${error.message}`, "error");
          processBtn.disabled = false;
          processBtn.innerHTML = "‚öôÔ∏è Process Video";
          progressSection.style.display = "none";
        }
      }

      // Start real-time progress streaming
      function startProgressStream(s3Url) {
        console.log("üì° Starting progress stream for:", s3Url);

        const eventSource = new EventSource(
          `${PROGRESS_STREAM_URL}?s3_url=${encodeURIComponent(s3Url)}`
        );

        eventSource.onopen = function (event) {
          console.log("üîó Progress stream connected");
          showStatus("üì° Connected to real-time progress stream", "info");
        };

        eventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            console.log("üìä Progress update received:", data);

            if (data.type === "connection") {
              showStatus("‚úÖ Connected to progress stream", "success");
            } else if (data.type === "heartbeat") {
              // Heartbeat - keep connection alive
              console.log("üíì Progress stream heartbeat");
            } else {
              // Progress update
              if (data.status === "running") {
                updateProgress(data.progress || 0, data.message);
                showStatus(`üîÑ ${data.message}`, "info");
              } else if (data.status === "completed") {
                updateProgress(100, "Processing completed successfully!");
                showStatus(
                  "üéâ Video processing completed successfully!",
                  "success"
                );
                displayResults(data.result);
                eventSource.close();
                processBtn.disabled = false;
                processBtn.innerHTML = "‚öôÔ∏è Process Video";
                processS3Btn.disabled = false;
                processS3Btn.innerHTML = "üöÄ Process S3 Video";
              } else if (data.status === "failed") {
                updateProgress(0, "Processing failed");
                showStatus(
                  `‚ùå Processing failed: ${data.error || data.message}`,
                  "error"
                );
                eventSource.close();
                processBtn.disabled = false;
                processBtn.innerHTML = "‚öôÔ∏è Process Video";
                processS3Btn.disabled = false;
                processS3Btn.innerHTML = "üöÄ Process S3 Video";
              }
            }
          } catch (error) {
            console.error("‚ùå Error parsing progress update:", error);
          }
        };

        eventSource.onerror = function (event) {
          console.error("‚ùå Progress stream error:", event);
          showStatus("‚ùå Progress stream connection lost", "error");
          eventSource.close();
          processBtn.disabled = false;
          processBtn.innerHTML = "‚öôÔ∏è Process Video";
          processS3Btn.disabled = false;
          processS3Btn.innerHTML = "üöÄ Process S3 Video";
        };
      }

      // Display results
      function displayResults(data) {
        console.log("üìä Displaying results:", data);
        resultsSection.style.display = "block";
        const resultsGrid = document.getElementById("resultsGrid");
        resultsGrid.innerHTML = "";

        // Store current results for persistence
        currentResults = data;

        // Save to local storage
        saveToLocalStorage(data, s3Url);

        // Show download button if segments are available
        if (data.s3_urls && data.s3_urls.length > 0) {
          downloadAllBtn.style.display = "block";
          clearResultsBtn.style.display = "block";
        } else {
          downloadAllBtn.style.display = "none";
          clearResultsBtn.style.display = "none";
        }

        // Video segments with preview
        if (data.s3_urls && data.s3_urls.length > 0) {
          const videoSegments = data.s3_urls.filter(
            (item) => item.segment_type === "topic"
          );
          if (videoSegments.length > 0) {
            const videoCard = createVideoPreviewCard(
              "Video Segments",
              videoSegments
            );
            resultsGrid.appendChild(videoCard);
          }
        }

        // Interaction segments with preview
        if (data.s3_urls && data.s3_urls.length > 0) {
          const interactionSegments = data.s3_urls.filter(
            (item) => item.segment_type === "interaction"
          );
          if (interactionSegments.length > 0) {
            const interactionCard = createVideoPreviewCard(
              "Interaction Segments",
              interactionSegments
            );
            resultsGrid.appendChild(interactionCard);
          }
        }
      }

      // Create result card
      function createResultCard(title, items, type) {
        const card = document.createElement("div");
        card.className = "result-card";

        let itemsHtml = "";
        items.forEach((item, index) => {
          if (typeof item === "string") {
            // For file paths, just show the filename
            const filename = item.split("/").pop();
            itemsHtml += `<div class="result-item">üìÅ ${filename}</div>`;
          } else if (item.url) {
            // For S3 URLs, show as clickable link
            itemsHtml += `<div class="result-item"><a href="${
              item.url
            }" target="_blank">üé¨ ${
              item.filename || `File ${index + 1}`
            }</a></div>`;
          }
        });

        card.innerHTML = `
                <h3>${title}</h3>
                ${itemsHtml}
            `;
        return card;
      }

      // Create video preview card
      function createVideoPreviewCard(title, segments) {
        const card = document.createElement("div");
        card.className = "result-card";

        let videosHtml = "";
        segments.forEach((item, index) => {
          if (item.s3_url) {
            videosHtml += `
              <div class="video-preview-item">
                <div class="video-preview-header">
                  <h4>üé¨ ${item.filename}</h4>
                  <span class="video-size">${
                    item.size_mb ? item.size_mb.toFixed(1) + " MB" : "N/A"
                  }</span>
                </div>
                <video controls preload="metadata" class="video-preview">
                  <source src="${item.s3_url}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              </div>
            `;
          }
        });

        card.innerHTML = `
          <h3>${title}</h3>
          <div class="video-preview-grid">
            ${videosHtml}
          </div>
        `;
        return card;
      }

      // Update progress
      function updateProgress(percent, text) {
        const progressFill = document.getElementById("progressFill");
        const progressPercentage =
          document.getElementById("progressPercentage");
        const progressText = document.querySelector(".progress-text");

        progressFill.style.width = percent + "%";
        progressPercentage.textContent = Math.round(percent) + "%";
        if (progressText) {
          progressText.textContent = text;
        }
      }

      // Show status message
      function showStatus(message, type = "info") {
        const statusDiv = document.createElement("div");
        statusDiv.className = `status ${type}`;
        statusDiv.innerHTML = message;

        statusContainer.appendChild(statusDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.parentNode.removeChild(statusDiv);
          }
        }, 5000);
      }

      // Download all segments
      async function downloadAllSegments() {
        // Use stored results if available, otherwise check DOM
        if (
          !currentResults ||
          !currentResults.s3_urls ||
          currentResults.s3_urls.length === 0
        ) {
          showStatus("No segments available to download.", "error");
          return;
        }

        downloadAllBtn.disabled = true;
        downloadAllBtn.innerHTML =
          '<span class="loading"></span>Preparing download...';

        try {
          const segments = currentResults.s3_urls.map((item, index) => ({
            url: item.s3_url,
            filename: item.filename || `segment_${index + 1}.mp4`,
            segment_type: item.segment_type,
          }));

          if (segments.length === 0) {
            throw new Error("No video segments found");
          }

          showStatus(
            `üì¶ Preparing ${segments.length} segments for download...`,
            "info"
          );

          // Download each segment and create a ZIP file
          const JSZip = await import(
            "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"
          );
          const zip = new JSZip.default();

          // Create folders for different segment types
          const topicFolder = zip.folder("topic_segments");
          const interactionFolder = zip.folder("interaction_segments");

          let downloadedCount = 0;
          const totalSegments = segments.length;

          for (const segment of segments) {
            try {
              const response = await fetch(segment.url);
              if (!response.ok) {
                console.warn(
                  `Failed to download ${segment.filename}: ${response.statusText}`
                );
                continue;
              }

              const blob = await response.blob();

              // Determine folder based on segment type
              if (segment.segment_type === "interaction") {
                interactionFolder.file(segment.filename, blob);
              } else {
                topicFolder.file(segment.filename, blob);
              }

              downloadedCount++;
              downloadAllBtn.innerHTML = `<span class="loading"></span>Downloading... (${downloadedCount}/${totalSegments})`;
            } catch (error) {
              console.error(`Error downloading ${segment.filename}:`, error);
            }
          }

          if (downloadedCount === 0) {
            throw new Error("Failed to download any segments");
          }

          // Generate and download the ZIP file
          downloadAllBtn.innerHTML =
            '<span class="loading"></span>Creating ZIP file...';
          const zipBlob = await zip.generateAsync({ type: "blob" });

          const url = URL.createObjectURL(zipBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `video_segments_${new Date()
            .toISOString()
            .slice(0, 10)}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showStatus(
            `‚úÖ Successfully downloaded ${downloadedCount} segments!`,
            "success"
          );
        } catch (error) {
          console.error("Download error:", error);
          showStatus(`Download failed: ${error.message}`, "error");
        } finally {
          downloadAllBtn.disabled = false;
          downloadAllBtn.innerHTML = "üì¶ Download All Segments";
        }
      }

      // Clear results
      function clearResults() {
        if (
          confirm(
            "Are you sure you want to clear all processing results and local storage?"
          )
        ) {
          clearLocalStorage();
          currentResults = null;
          s3Url = null;
          presignedUrl = null;
          uploadBtn.style.display = "inline-block";
          processBtn.style.display = "none";
          downloadAllBtn.style.display = "none";
          clearResultsBtn.style.display = "none";
          fileInfo.style.display = "none";
          s3Info.style.display = "none";
          s3UrlInput.value = "";
          processS3Btn.style.display = "none";
          showStatus("All processing results and local data cleared.", "info");
          resultsSection.style.display = "none"; // Hide results section
        }
      }
    </script>
  </body>
</html>
